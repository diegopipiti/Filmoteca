{% extends "catalogo/base.html" %}

{% block title %}Catalogo{% endblock %}

    
{% block content %}

      <div class="container-fluid px-0 px-lg-1 catalogo-grid">

        {% if messages %}
        <div class="row">
            <div class="col-12">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}


        <!-- BANNER -->
        {% if random_movie %}
           {% include "catalogo/_banner_random.html" with movie=random_movie %}
        {% endif %}

            <!-- Tabella -->
            <div class="row g-2 gx-2 gy-3 px-1 px-lg-2">
                <!-- Titolo sezione -->
                <div class="col-12">
                    <div class="d-flex flex-column mb-3 mt-4">
                        
                        <div class="d-flex justify-content-between align-items-end">
                            <div>
                                <h2 class="text-light fw-bold mb-0" style="font-size: 1.4rem;">
                                    La tua collezione
                                </h2>
                                <span class="text-secondary small">
                                    {{ page_obj.paginator.count }} titoli totali
                                </span>
                            </div>

                            {% if movies %}
                                <div class="d-none d-md-block">
                                    <a href="{% url 'movie_detail' movies.0.pk %}"
                                    class="btn btn-outline-light btn-sm">
                                        📖 Vista dettagliata
                                    </a>
                                </div>
                            {% endif %}
                        </div>

                    </div>
                </div>

                {% if movies %}
                    {% for m in movies %}
                        <div class="col-6 col-md-4 col-lg-3 col-xl-2 mb-3">
                            <a
                                href="#"
                                class="text-decoration-none text-light"
                                data-bs-toggle="modal"
                                data-bs-target="#movieModal"
                                data-title="{{ m.titolo }}"
                                data-movie-id="{{ m.pk }}"
                                data-anno="{{ m.anno }}"
                                data-genere="{{ m.genere }}"
                                data-regista="{{ m.regista }}"
                                data-visto="{{ m.visto }}"
                                data-voto="{{ m.voto }}"
                                data-percorso="{{ m.percorso }}"
                                data-poster="{{ m.locandina_url }}"
                                data-dimensione="{{ m.dimensione_file_mb }}"
                                data-codifica="{{ m.codifica }}"
                                data-trama="{{ m.trama|default_if_none:'' }}"
                                data-updateposter-url="{% url 'update_movie_poster' m.pk %}"
                                data-play-url="{% url 'movie_play' m.pk %}"
                                data-detail-url="{% url 'movie_detail' m.pk %}"
                                data-edit-url="{% url 'movie_edit' m.pk %}?next={{ request.get_full_path|urlencode }}"
                                data-delete-url="{% url 'movie_delete' m.pk %}"
                            >
                                <div class="card h-100 bg-dark border-0">
                                    <div class="poster-wrapper">
                                        <div class="ratio-2x3">
                                            {% if m.locandina_url %}
                                                <img src="{{ m.locandina_url }}"
                                                    class="poster-img"
                                                    alt="{{ m.titolo }}">
                                            {% else %}
                                                <div class="poster-placeholder d-flex align-items-center justify-content-center">
                                                    <span class="small text-center px-2">
                                                        {{ m.titolo }}
                                                    </span>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="col-12">
                        <p class="mt-3 mb-0 text-center">
                            Nessun film presente. Aggiungine uno dall'admin.
                        </p>
                    </div>
                {% endif %}
            
                            {% if is_paginated %}
                                <nav class="mt-3">
                                    <ul class="pagination justify-content-center amb-pagination">

                                        {# Link pagina precedente #}
                                        {% if page_obj.has_previous %}
                                            <li class="page-item">
                                                <a class="page-link"
                                                href="?{% if base_query %}{{ base_query }}&{% endif %}page={{ page_obj.previous_page_number }}">
                                                    Â« Prec
                                                </a>
                                            </li>
                                        {% else %}
                                            <li class="page-item disabled">
                                                <span class="page-link">Â« Prec</span>
                                            </li>
                                        {% endif %}

                                        {# Numeri di pagina #}
                                        {% for num in page_obj.paginator.page_range %}
                                            {% if num == page_obj.number %}
                                                <li class="page-item active" aria-current="page">
                                                    <span class="page-link">
                                                        {{ num }}
                                                    </span>
                                                </li>
                                            {% else %}
                                                <li class="page-item">
                                                    <a class="page-link"
                                                    href="?{% if base_query %}{{ base_query }}&{% endif %}page={{ num }}">
                                                        {{ num }}
                                                    </a>
                                                </li>
                                            {% endif %}
                                        {% endfor %}

                                        {# Link pagina successiva #}
                                        {% if page_obj.has_next %}
                                            <li class="page-item">
                                                <a class="page-link"
                                                href="?{% if base_query %}{{ base_query }}&{% endif %}page={{ page_obj.next_page_number }}">
                                                    Succ Â»
                                                </a>
                                            </li>
                                        {% else %}
                                            <li class="page-item disabled">
                                                <span class="page-link">Succ Â»</span>
                                            </li>
                                        {% endif %}

                                    </ul>
                                </nav>
                            {% endif %}

                        </div>

                    </div>
                </div>
            </div>

    </div>
    <!-- Modal dettaglio film -->
    <div class="modal fade" id="movieModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark text-light border-secondary">
        <div class="modal-header border-secondary">
            <h5 class="modal-title"></h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Chiudi"></button>
        </div>
        <div class="modal-body">

            <div class="row">
            <div class="col-12 col-md-4 mb-3">
                <img data-role="poster"
                    src=""
                    alt=""
                    class="img-fluid rounded shadow d-none">
                <div data-role="poster-placeholder"
                    class="bg-secondary d-flex align-items-center justify-content-center rounded w-100 d-none"
                    style="padding-top:150%;">
                <span class="small text-center px-2">
                    Nessuna locandina disponibile
                </span>
                </div>
            </div>

            <div class="col-12 col-md-8 d-flex flex-column">
                <p class="mb-1"><strong>Anno:</strong> <span data-role="anno"></span></p>
                <p class="mb-1"><strong>Genere:</strong> <span data-role="genere"></span></p>
                <p class="mb-1"><strong>Regista:</strong> <span data-role="regista"></span></p>
                <p class="mb-1"><strong>Visto:</strong> <span data-role="visto"></span></p>
                <div class="mb-3 d-flex align-items-center gap-2">
                    <strong class="me-1">Voto:</strong>
                    <span data-role="voto-stars" class="rating-stars"></span>
                    <span data-role="voto-num" class="small text-secondary"></span>
                </div>

                <!-- TRAMA -->
                <div class="mb-3">
                    <span class="text-secondary fw-semibold d-block mb-1">Trama:</span>
                    <p class="small mb-0" data-role="trama"></p>
                </div>

                <p class="small mb-1">
                <span class="text-secondary fw-semibold">Percorso file:</span><br>
                <span data-role="percorso" class="text-light"></span>
                </p>
                <p class="small mb-1">
                <span class="text-secondary fw-semibold">Dimensione:</span>
                <span data-role="dimensione" class="text-light"></span> MB
                </p>
                <p class="small mb-3">
                <span class="text-secondary fw-semibold">Codifica:</span>
                <span data-role="codifica" class="text-light"></span>
                </p>


                <div class="mt-auto mb-3 d-flex flex-wrap gap-3 justify-content-end">

                    <!-- Riproduci -->
                    <a
                        data-role="play-btn"
                        class="amb-circle-btn amb-play"
                        data-bs-toggle="tooltip"
                        data-bs-placement="top"
                        data-bs-custom-class="amb-tooltip"
                        data-bs-title="Riproduci"
                    >
                        <i class="bi bi-play-fill"></i>
                    </a>

                    <!-- Scheda completa -->
                        <a 
                        data-role="detail-btn" 
                        class="amb-circle-btn" 
                        data-bs-toggle="tooltip"
                        data-bs-placement="top"
                        data-bs-custom-class="amb-tooltip" 
                        data-bs-title="Apri la scheda"
                        >
                        <i class="bi bi-card-list"></i>
                    </a>

                    <!-- Modifica -->
                    <a
                        data-role="edit-btn"
                        class="amb-circle-btn amb-edit"
                        data-bs-toggle="tooltip"
                        data-bs-placement="top"
                        data-bs-custom-class="amb-tooltip"
                        data-bs-title="Modifica scheda"
                    >
                        <i class="bi bi-pencil"></i>
                    </a>

                    <!-- Aggiorna -->
                    <a data-role="updateposter-btn" 
                        class="amb-circle-btn" 
                        data-bs-toggle="tooltip" 
                        data-bs-placement="top"
                        data-bs-custom-class="amb-tooltip"
                        data-bs-title="Aggiorna metadati"
                    >
                        <i class="bi bi-arrow-repeat"></i>
                    </a>

                    <!-- Elimina -->
                    <a data-role="delete-btn" 
                        class="amb-circle-btn amb-danger" 
                        data-bs-toggle="tooltip" 
                        data-bs-placement="top"
                        data-bs-custom-class="amb-tooltip"
                        data-bs-title="Elimina"
                    >
                    <i class="bi bi-trash"></i>
                    </a>

                </div>


                </div>

            </div>
            </div>

        </div>
        </div>
    </div>
    </div>
{% endblock %}




{% block extra_js %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {

            // 1) Inizializza TUTTI i tooltip della pagina
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (el) {
                return new bootstrap.Tooltip(el);
            });

            // 2) Tutto il resto (modale, ecc.)
            var movieModal = document.getElementById('movieModal');
            if (!movieModal) return;

            function renderStars(container, voto10) {
                var voto = parseFloat(voto10);
                if (isNaN(voto)) {
                    container.innerHTML = '';
                    return;
                }
                var stars = Math.max(0, Math.min(5, voto / 2));
                var full = Math.floor(stars);
                var half = (stars - full) >= 0.5 ? 1 : 0;
                var empty = 5 - full - half;
                var html = '';
                for (var i = 0; i < full; i++) html += '<span class="star"></span>';
                if (half) html += '<span class="star half"></span>';
                for (var i = 0; i < empty; i++) html += '<span class="star empty"></span>';
                container.innerHTML = html;
            }

            movieModal.addEventListener('show.bs.modal', function (event) {
                var trigger = event.relatedTarget;
                if (!trigger) return;

                var title   = trigger.getAttribute('data-title') || '';
                var anno    = trigger.getAttribute('data-anno')  || '';
                var genere  = trigger.getAttribute('data-genere') || '';
                var regista = trigger.getAttribute('data-regista') || '';
                var visto   = trigger.getAttribute('data-visto') || '';
                var voto    = trigger.getAttribute('data-voto') || '';
                var percorso = trigger.getAttribute('data-percorso') || '';
                var poster   = trigger.getAttribute('data-poster') || '';
                var dimensione = trigger.getAttribute('data-dimensione') || '';
                var codifica   = trigger.getAttribute('data-codifica') || '';
                var trama     = trigger.getAttribute('data-trama') || '';

                var playUrl        = trigger.getAttribute('data-play-url')   || '#';
                var editUrl        = trigger.getAttribute('data-edit-url')   || '#';
                var deleteUrl      = trigger.getAttribute('data-delete-url') || '#';
                var updatePosterUrl = trigger.getAttribute('data-updateposter-url') || '#';
                var detailUrl      = trigger.getAttribute('data-detail-url') || '#';

                movieModal.querySelector('.modal-title').textContent = title;

                var posterImg = movieModal.querySelector('[data-role="poster"]');
                var posterPlaceholder = movieModal.querySelector('[data-role="poster-placeholder"]');
                if (poster) {
                    posterImg.src = poster;
                    posterImg.alt = title;
                    posterImg.classList.remove('d-none');
                    posterPlaceholder.classList.add('d-none');
                } else {
                    posterImg.classList.add('d-none');
                    posterPlaceholder.classList.remove('d-none');
                }

                movieModal.querySelector('[data-role="anno"]').textContent = anno || '-';
                movieModal.querySelector('[data-role="genere"]').textContent = genere || '-';
                movieModal.querySelector('[data-role="regista"]').textContent = regista || '-';

                movieModal.querySelector('[data-role="visto"]').textContent =
                    (visto === 'True' || visto === 'true' || visto === '1') ? 'Si' : 'No';

                var votoStarsEl = movieModal.querySelector('[data-role="voto-stars"]');
                var votoNumEl = movieModal.querySelector('[data-role="voto-num"]');
                if (votoStarsEl) renderStars(votoStarsEl, voto);
                if (votoNumEl) votoNumEl.textContent = voto ? '(' + voto + '/10)' : '';

                movieModal.querySelector('[data-role="trama"]').textContent = trama || '';
                movieModal.querySelector('[data-role="percorso"]').textContent = percorso || '';
                movieModal.querySelector('[data-role="dimensione"]').textContent = dimensione || '-';
                movieModal.querySelector('[data-role="codifica"]').textContent = codifica || '-';

                movieModal.querySelector('[data-role="play-btn"]').href        = playUrl;
                movieModal.querySelector('[data-role="edit-btn"]').href        = editUrl;
                movieModal.querySelector('[data-role="delete-btn"]').href      = deleteUrl;
                movieModal.querySelector('[data-role="updateposter-btn"]').href = updatePosterUrl;
                var detailBtn = movieModal.querySelector('[data-role="detail-btn"]');
                if (detailBtn) {
                    detailBtn.href = detailUrl;
                }

                var detailBtn = movieModal.querySelector('[data-role="detail-btn"]');
                    if (detailBtn) {
                        detailBtn.onclick = function (e) {
                            e.preventDefault();
                            var url = trigger.getAttribute("data-detail-url");
                            if (url && url !== "#") window.location.href = url;
                        };
                    }

        });

        // Click su “Modifica”: salva scroll e vai alla pagina
        var editBtn = movieModal.querySelector('[data-role="edit-btn"]');
        if (editBtn) {
            editBtn.addEventListener('click', function (e) {
                e.preventDefault();
                var href = editBtn.getAttribute('href');
                if (!href) return;
                sessionStorage.setItem('movie_list_scroll', Math.round(window.scrollY).toString());
                var current = new URL(window.location.href);
                var nextValue = current.pathname + (current.search ? current.search : '');
                var target = new URL(href, window.location.origin);
                target.searchParams.set('next', nextValue);
                window.location.href = target.toString();
            });
        }

        // ?open=ID apre la modale automaticamente
        const params = new URLSearchParams(window.location.search);
        const openId = params.get('open');
        if (openId) {
            const trigger = document.querySelector('[data-movie-id="' + openId + '"]');
            if (trigger) trigger.click();
        }

        // Ripristina scroll da sessionStorage
        const savedScroll = sessionStorage.getItem('movie_list_scroll');
        if (savedScroll !== null) {
            const pos = parseInt(savedScroll, 10);
            if (!isNaN(pos)) window.scrollTo(0, pos);
            sessionStorage.removeItem('movie_list_scroll');
        }
    });
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const banner = document.querySelector('.random-banner');
        if (!banner) return;

        // FRECCE: ogni click ricarica la pagina -> la view sceglie un nuovo random_movie
        banner.querySelectorAll('.amb-banner-arrow').forEach(function (btn) {
            btn.addEventListener('click', function (e) {
                e.preventDefault();
                // semplice reload: la view sceglie un altro film casuale
                window.location.reload();
            });
        });

        // PLAY: lasciamo che il browser segua l'href (non deve toccare il banner)
        const playBtn = banner.querySelector('.amb-btn-play');
        if (playBtn) {
            playBtn.addEventListener('click', function (e) {
                // nessun preventDefault: così va al player
            });
        }
    });
    </script>


{% endblock %}









