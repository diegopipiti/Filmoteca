{% extends "catalogo/base.html" %}

{% block title %}Catalogo{% endblock %}
{% block nav_home_active %} active{% endblock %}
    
{% block content %}




        <!-- MODAL FILTRI AVANZATI -->
    <div class="modal fade" id="filterModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content bg-dark text-light border-secondary">
        <div class="modal-header border-secondary">
            <h5 class="modal-title">Filtri avanzati</h5>
            <button type="button"
                    class="btn-close btn-close-white"
                    data-bs-dismiss="modal"
                    aria-label="Chiudi"></button>
        </div>

        <!-- FORM FILTRI (GET) -->
        <form method="get" action="{% url 'movie_list' %}">
            <div class="modal-body">
            <div class="row g-3">

                <!-- Titolo -->
                <div class="col-12">
                <label class="form-label">Titolo contiene</label>
                <input type="text" name="titolo" class="form-control form-control-sm"
                        value="{{ filtri.titolo|default:'' }}">
                </div>

                <!-- Anno da/a -->
                <div class="col-12 col-md-6">
                <label class="form-label">Anno</label>
                <div class="d-flex gap-1">
                    <input type="number" name="anno_da" class="form-control form-control-sm"
                        placeholder="da"
                        value="{{ filtri.anno_da|default:'' }}">
                    <input type="number" name="anno_a" class="form-control form-control-sm"
                        placeholder="a"
                        value="{{ filtri.anno_a|default:'' }}">
                </div>
                </div>

                <!-- Genere -->
                <div class="col-12 col-md-6">
                <label class="form-label">Genere contiene</label>
                <input type="text" name="genere" class="form-control form-control-sm"
                        value="{{ filtri.genere|default:'' }}">
                </div>

                <!-- Regista -->
                <div class="col-12 col-md-6">
                <label class="form-label">Regista contiene</label>
                <input type="text" name="regista" class="form-control form-control-sm"
                        value="{{ filtri.regista|default:'' }}">
                </div>

                <!-- Visto -->
                <div class="col-12 col-md-6">
                <label class="form-label">GiÃ  visto?</label>
                <select name="visto" class="form-select form-select-sm">
                    <option value="" {% if not filtri.visto %}selected{% endif %}>Tutti</option>
                    <option value="si" {% if filtri.visto == "si" %}selected{% endif %}>Solo visti</option>
                    <option value="no" {% if filtri.visto == "no" %}selected{% endif %}>Solo non visti</option>
                </select>
                </div>

                <!-- Voto -->
                <div class="col-12 col-md-6">
                <label class="form-label">Voto</label>
                <div class="d-flex gap-1">
                    <input type="number" name="voto_da" class="form-control form-control-sm"
                        placeholder="da"
                        value="{{ filtri.voto_da|default:'' }}">
                    <input type="number" name="voto_a" class="form-control form-control-sm"
                        placeholder="a"
                        value="{{ filtri.voto_a|default:'' }}">
                </div>
                </div>

                <!-- Codifica -->
                <div class="col-12 col-md-6">
                <label class="form-label">Codifica contiene</label>
                <input type="text" name="codifica" class="form-control form-control-sm"
                        value="{{ filtri.codifica|default:'' }}">
                </div>

                <!-- Estensione -->
                <div class="col-12 col-md-6">
                <label class="form-label">Estensione contiene</label>
                <input type="text" name="estensione" class="form-control form-control-sm"
                        value="{{ filtri.estensione|default:'' }}">
                </div>

                <!-- Dimensione file -->
                <div class="col-12 col-md-6">
                <label class="form-label">Dimensione file (MB)</label>
                <div class="d-flex gap-1">
                    <input type="number" step="0.01" name="dim_da"
                        class="form-control form-control-sm"
                        placeholder="da"
                        value="{{ filtri.dim_da|default:'' }}">
                    <input type="number" step="0.01" name="dim_a"
                        class="form-control form-control-sm"
                        placeholder="a"
                        value="{{ filtri.dim_a|default:'' }}">
                </div>
                </div>

                <!-- Percorso -->
                <div class="col-12">
                <label class="form-label">Percorso contiene</label>
                <input type="text" name="percorso" class="form-control form-control-sm"
                        value="{{ filtri.percorso|default:'' }}">
                </div>

            </div>
            </div>

            <div class="modal-footer border-secondary">
            <a href="{% url 'movie_list' %}" class="btn btn-outline-light btn-sm">
                Reset
            </a>
            <button type="submit" class="btn btn-sm">
                Applica filtri
            </button>
            </div>
        </form>

        </div>
    </div>
    </div>

        <!-- MODAL SCANSIONE CARTELLA -->
    <div class="modal fade" id="scanModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-scrollable">
        <div class="modal-content bg-dark text-light border-secondary">
        <div class="modal-header border-secondary">
            <h5 class="modal-title">Scansiona cartella</h5>
            <button type="button"
                    class="btn-close btn-close-white"
                    data-bs-dismiss="modal"
                    aria-label="Chiudi"></button>
        </div>

        <form method="post" action="{% url 'scan_folder' %}" class="small">
            {% csrf_token %}
            <div class="modal-body">
            <div class="mb-2">
                <label class="form-label">Percorso cartella</label>
                <input type="text"
                    name="base_dir"
                    class="form-control form-control-sm"
                    placeholder="Es. D:\Film">
            </div>
            <p class="form-text text-light mt-2">
                Cerca file video nelle sottocartelle e li aggiunge al catalogo
                (solo nuovi percorsi).
            </p>
            </div>

            <div class="modal-footer border-secondary">
            <button type="button"
                    class="btn btn-outline-secondary btn-sm"
                    data-bs-dismiss="modal">
                Annulla
            </button>
            <button type="submit" class="btn btn-outline-light btn-sm">
                Scansiona e aggiungi film
            </button>
            </div>
        </form>
        </div>
    </div>
    </div>

        <!-- MODAL METADATI -->
    <div class="modal fade" id="metadataModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-scrollable">
        <div class="modal-content bg-dark text-light border-secondary">
        <div class="modal-header border-secondary">
            <h5 class="modal-title">Aggiorna metadati</h5>
            <button type="button"
                    class="btn-close btn-close-white"
                    data-bs-dismiss="modal"
                    aria-label="Chiudi"></button>
        </div>

        <form method="post" action="{% url 'update_posters' %}" class="small">
            {% csrf_token %}
            <div class="modal-body">
            <p class="small mb-2">
                Trova e aggiorna i metadati mancanti consultando TMDB
                (trama, anno, genere, regista, locandina) per i film senza trama.
            </p>
            <p class="small text-muted mb-0">
                L'operazione potrebbe richiedere qualche istante a seconda del numero di film.
            </p>
            </div>

            <div class="modal-footer border-secondary">
            <button type="button"
                    class="btn btn-outline-secondary btn-sm"
                    data-bs-dismiss="modal">
                Annulla
            </button>
            <button type="submit" class="btn btn-outline-light btn-sm">
                Trova/Aggiorna metadati
            </button>
            </div>
        </form>

        </div>
    </div>
    </div>


      <div class="container-fluid px-0 px-lg-1 catalogo-grid">

        {% if messages %}
        <div class="row">
            <div class="col-12">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div class="row mb-4">
            <div class="col">
            {% if random_movie %}
                <div class="random-banner mb-4 position-relative rounded overflow-hidden">
                    
                    <!-- FRECCIA SINISTRA -->
                    <button onclick="window.location.reload()"
                            class="banner-arrow banner-arrow-left">
                        &#10094;
                    </button>

                    <!-- FRECCIA DESTRA -->
                    <button onclick="window.location.reload()"
                            class="banner-arrow banner-arrow-right">
                        &#10095;
                    </button>

                    <!-- SFONDO -->
                    <div class="position-absolute top-0 start-0 w-100 h-100"
                        style="
                            background-image: url('{{ random_movie.locandina_url }}');
                            background-size: cover;
                            background-position: center;
                            filter: blur(8px);
                            transform: scale(1.1);
                            opacity: 0.85;
                        ">
                    </div>

                    <!-- OVERLAY LEGGERISSIMO -->
                    <div class="position-absolute top-0 start-0 w-100 h-100"
                        style="
                            background: linear-gradient(
                                rgba(0,0,0,0.25),
                                rgba(0,0,0,0.45)
                                );
                        ">
                    </div>



                    <!-- CONTENUTO -->
                    <div class="position-relative text-center text-light px-3 py-5"
                        style="z-index: 5;">

                        <!-- TITOLO -->
                        <h1 class="fw-bold display-5 mb-3">
                            {{ random_movie.titolo }}
                        </h1>

                        <!-- BADGE -->
                        <div class="mb-3">
                            {% if random_movie.anno %}
                                <span class="badge bg-light text-dark me-1">
                                    {{ random_movie.anno }}
                                </span>
                            {% endif %}

                            {% if random_movie.genere %}
                                <span class="badge bg-secondary me-1">
                                    {{ random_movie.genere }}
                                </span>
                            {% endif %}

                            {% if random_movie.voto %}
                                <span class="badge bg-warning text-dark">
                                    â˜… {{ random_movie.voto }}/10
                                </span>
                            {% endif %}
                        </div>

                        <!-- TRAMA -->
                        {% if random_movie.trama %}
                        <p class="lead fw-normal mb-4 d-none d-md-block"
                        style="max-width: 720px; margin: 0 auto;">
                            {{ random_movie.trama|truncatechars:160 }}
                        </p>
                        {% endif %}

                        <!-- BOTTONI -->
                        <div class="d-flex justify-content-center gap-3 mt-3">
                            <!-- PLAY -->
                            <a href="{% url 'movie_play' random_movie.pk %}?next={{ request.get_full_path|urlencode }}"
                            class="amb-btn amb-btn-play">
                                <span class="amb-btn-icon-play"></span>
                                <span>Riproduci</span>
                            </a>

                            <!-- ALTRE INFO -->
                            <button type="button"
                                    class="amb-btn amb-btn-info"
                                    data-bs-toggle="modal"
                                    data-bs-target="#movieModal"
                                    data-movie-id="{{ random_movie.pk }}">
                                <span class="amb-btn-icon-info">i</span>
                                <span>Altre info</span>
                            </button>
                        </div>

                    </div>

                </div>
                {% endif %}


            </div>
        </div>


            <!-- Tabella -->
            <div class="row g-2 gx-2 gy-3 px-1 px-lg-2">
                <!-- Titolo sezione -->
                <div class="col-12">
                    <div class="d-flex flex-column mb-3 mt-4">
                        <h2 class="text-light fw-bold mb-0" style="font-size: 1.4rem;">
                            La tua collezione
                        </h2>
                        <span class="text-secondary small">
                            {{ page_obj.paginator.count }} titoli totali
                        </span>
                    </div>
                </div>

                {% if movies %}
                    {% for m in movies %}
                        <div class="col-6 col-md-4 col-lg-3 col-xl-2 mb-3">
                            <a
                                href="#"
                                class="text-decoration-none text-light"
                                data-bs-toggle="modal"
                                data-bs-target="#movieModal"
                                data-title="{{ m.titolo }}"
                                data-movie-id="{{ m.pk }}"
                                data-anno="{{ m.anno }}"
                                data-genere="{{ m.genere }}"
                                data-regista="{{ m.regista }}"
                                data-visto="{{ m.visto }}"
                                data-voto="{{ m.voto }}"
                                data-percorso="{{ m.percorso }}"
                                data-poster="{{ m.locandina_url }}"
                                data-dimensione="{{ m.dimensione_file_mb }}"
                                data-codifica="{{ m.codifica }}"
                                data-trama="{{ m.trama|default_if_none:'' }}"
                                data-updateposter-url="{% url 'update_movie_poster' m.pk %}"
                                data-play-url="{% url 'movie_play' m.pk %}"
                                data-detail-url="{% url 'movie_detail' m.pk %}"
                                data-edit-url="{% url 'movie_edit' m.pk %}?next={{ request.get_full_path|urlencode }}"
                                data-delete-url="{% url 'movie_delete' m.pk %}"
                            >
                                <div class="card h-100 bg-dark border-0">
                                    <div class="poster-wrapper">
                                        <div class="ratio-2x3">
                                            {% if m.locandina_url %}
                                                <img src="{{ m.locandina_url }}"
                                                    class="poster-img"
                                                    alt="{{ m.titolo }}">
                                            {% else %}
                                                <div class="poster-placeholder d-flex align-items-center justify-content-center">
                                                    <span class="small text-center px-2">
                                                        {{ m.titolo }}
                                                    </span>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="col-12">
                        <p class="mt-3 mb-0 text-center">
                            Nessun film presente. Aggiungine uno dall'admin.
                        </p>
                    </div>
                {% endif %}
            
                            {% if is_paginated %}
                                <nav class="mt-3">
                                    <ul class="pagination justify-content-center amb-pagination">

                                        {# Link pagina precedente #}
                                        {% if page_obj.has_previous %}
                                            <li class="page-item">
                                                <a class="page-link"
                                                href="?{% if base_query %}{{ base_query }}&{% endif %}page={{ page_obj.previous_page_number }}">
                                                    Â« Prec
                                                </a>
                                            </li>
                                        {% else %}
                                            <li class="page-item disabled">
                                                <span class="page-link">Â« Prec</span>
                                            </li>
                                        {% endif %}

                                        {# Numeri di pagina #}
                                        {% for num in page_obj.paginator.page_range %}
                                            {% if num == page_obj.number %}
                                                <li class="page-item active" aria-current="page">
                                                    <span class="page-link">
                                                        {{ num }}
                                                    </span>
                                                </li>
                                            {% else %}
                                                <li class="page-item">
                                                    <a class="page-link"
                                                    href="?{% if base_query %}{{ base_query }}&{% endif %}page={{ num }}">
                                                        {{ num }}
                                                    </a>
                                                </li>
                                            {% endif %}
                                        {% endfor %}

                                        {# Link pagina successiva #}
                                        {% if page_obj.has_next %}
                                            <li class="page-item">
                                                <a class="page-link"
                                                href="?{% if base_query %}{{ base_query }}&{% endif %}page={{ page_obj.next_page_number }}">
                                                    Succ Â»
                                                </a>
                                            </li>
                                        {% else %}
                                            <li class="page-item disabled">
                                                <span class="page-link">Succ Â»</span>
                                            </li>
                                        {% endif %}

                                    </ul>
                                </nav>
                            {% endif %}

                        </div>

                    </div>
                </div>
            </div>

    </div>
    <!-- Modal dettaglio film -->
    <div class="modal fade" id="movieModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark text-light border-secondary">
        <div class="modal-header border-secondary">
            <h5 class="modal-title"></h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Chiudi"></button>
        </div>
        <div class="modal-body">

            <div class="row">
            <div class="col-12 col-md-4 mb-3">
                <img data-role="poster"
                    src=""
                    alt=""
                    class="img-fluid rounded shadow d-none">
                <div data-role="poster-placeholder"
                    class="bg-secondary d-flex align-items-center justify-content-center rounded w-100 d-none"
                    style="padding-top:150%;">
                <span class="small text-center px-2">
                    Nessuna locandina disponibile
                </span>
                </div>
            </div>

            <div class="col-12 col-md-8 d-flex flex-column">
                <p class="mb-1"><strong>Anno:</strong> <span data-role="anno"></span></p>
                <p class="mb-1"><strong>Genere:</strong> <span data-role="genere"></span></p>
                <p class="mb-1"><strong>Regista:</strong> <span data-role="regista"></span></p>
                <p class="mb-1"><strong>Visto:</strong> <span data-role="visto"></span></p>
                <div class="mb-3 d-flex align-items-center gap-2">
                    <strong class="me-1">Voto:</strong>
                    <span data-role="voto-stars" class="rating-stars"></span>
                    <span data-role="voto-num" class="small text-secondary"></span>
                </div>

                <!-- TRAMA -->
                <div class="mb-3">
                    <span class="text-secondary fw-semibold d-block mb-1">Trama:</span>
                    <p class="small mb-0" data-role="trama"></p>
                </div>

                <p class="small mb-1">
                <span class="text-secondary fw-semibold">Percorso file:</span><br>
                <span data-role="percorso" class="text-light"></span>
                </p>
                <p class="small mb-1">
                <span class="text-secondary fw-semibold">Dimensione:</span>
                <span data-role="dimensione" class="text-light"></span> MB
                </p>
                <p class="small mb-3">
                <span class="text-secondary fw-semibold">Codifica:</span>
                <span data-role="codifica" class="text-light"></span>
                </p>


                                <div class="mt-auto mb-2 d-flex flex-wrap gap-2 justify-content-end movie-modal-actions">

                    <a data-role="play-btn" class="btn btn-sm d-inline-flex align-items-center gap-1">
                        <svg aria-hidden="true" width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg" style="display:block;">
                            <polygon points="3,2 11,7 3,12" fill="#111"/>
                        </svg>
                        <span>Riproduci</span>
                    </a>

                    <a data-role="edit-btn" class="btn btn-sm">
                        <span>Modifica</span>
                    </a>

                    <a data-role="updateposter-btn" href="#" class="btn btn-sm">
                        <span>Aggiorna metadati</span>
                    </a>

                    <a data-role="delete-btn" class="btn btn-sm">
                        <span>Elimina</span>
                    </a>

                </div>

            </div>
            </div>

        </div>
        </div>
    </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    var movieModal = document.getElementById('movieModal');
    if (!movieModal) return;

    function renderStars(container, voto10) {
        var voto = parseFloat(voto10);
        if (isNaN(voto)) {
            container.innerHTML = '';
            return;
        }
        var stars = Math.max(0, Math.min(5, voto / 2));
        var full = Math.floor(stars);
        var half = (stars - full) >= 0.5 ? 1 : 0;
        var empty = 5 - full - half;
        var html = '';
        for (var i = 0; i < full; i++) html += '<span class="star"></span>';
        if (half) html += '<span class="star half"></span>';
        for (var i = 0; i < empty; i++) html += '<span class="star empty"></span>';
        container.innerHTML = html;
    }

    movieModal.addEventListener('show.bs.modal', function (event) {
        var trigger = event.relatedTarget;
        if (!trigger) return;

        var title   = trigger.getAttribute('data-title') || '';
        var anno    = trigger.getAttribute('data-anno')  || '';
        var genere  = trigger.getAttribute('data-genere') || '';
        var regista = trigger.getAttribute('data-regista') || '';
        var visto   = trigger.getAttribute('data-visto') || '';
        var voto    = trigger.getAttribute('data-voto') || '';
        var percorso = trigger.getAttribute('data-percorso') || '';
        var poster   = trigger.getAttribute('data-poster') || '';
        var dimensione = trigger.getAttribute('data-dimensione') || '';
        var codifica   = trigger.getAttribute('data-codifica') || '';
        var trama     = trigger.getAttribute('data-trama') || '';

        var playUrl        = trigger.getAttribute('data-play-url')   || '#';
        var editUrl        = trigger.getAttribute('data-edit-url')   || '#';
        var deleteUrl      = trigger.getAttribute('data-delete-url') || '#';
        var updatePosterUrl = trigger.getAttribute('data-updateposter-url') || '#';

        movieModal.querySelector('.modal-title').textContent = title;

        var posterImg = movieModal.querySelector('[data-role="poster"]');
        var posterPlaceholder = movieModal.querySelector('[data-role="poster-placeholder"]');
        if (poster) {
            posterImg.src = poster;
            posterImg.alt = title;
            posterImg.classList.remove('d-none');
            posterPlaceholder.classList.add('d-none');
        } else {
            posterImg.classList.add('d-none');
            posterPlaceholder.classList.remove('d-none');
        }

        movieModal.querySelector('[data-role="anno"]').textContent = anno || '-';
        movieModal.querySelector('[data-role="genere"]').textContent = genere || '-';
        movieModal.querySelector('[data-role="regista"]').textContent = regista || '-';

        movieModal.querySelector('[data-role="visto"]').textContent =
            (visto === 'True' || visto === 'true' || visto === '1') ? 'Si' : 'No';

        var votoStarsEl = movieModal.querySelector('[data-role="voto-stars"]');
        var votoNumEl = movieModal.querySelector('[data-role="voto-num"]');
        if (votoStarsEl) renderStars(votoStarsEl, voto);
        if (votoNumEl) votoNumEl.textContent = voto ? '(' + voto + '/10)' : '';

        movieModal.querySelector('[data-role="trama"]').textContent = trama || '';
        movieModal.querySelector('[data-role="percorso"]').textContent = percorso || '';
        movieModal.querySelector('[data-role="dimensione"]').textContent = dimensione || '-';
        movieModal.querySelector('[data-role="codifica"]').textContent = codifica || '-';

        movieModal.querySelector('[data-role="play-btn"]').href        = playUrl;
        movieModal.querySelector('[data-role="edit-btn"]').href        = editUrl;
        movieModal.querySelector('[data-role="delete-btn"]').href      = deleteUrl;
        movieModal.querySelector('[data-role="updateposter-btn"]').href = updatePosterUrl;

    });

    // Click su “Modifica”: salva scroll e vai alla pagina
    var editBtn = movieModal.querySelector('[data-role="edit-btn"]');
    if (editBtn) {
        editBtn.addEventListener('click', function (e) {
            e.preventDefault();
            var href = editBtn.getAttribute('href');
            if (!href) return;
            sessionStorage.setItem('movie_list_scroll', Math.round(window.scrollY).toString());
            var current = new URL(window.location.href);
            var nextValue = current.pathname + (current.search ? current.search : '');
            var target = new URL(href, window.location.origin);
            target.searchParams.set('next', nextValue);
            window.location.href = target.toString();
        });
    }

    // ?open=ID apre la modale automaticamente
    const params = new URLSearchParams(window.location.search);
    const openId = params.get('open');
    if (openId) {
        const trigger = document.querySelector('[data-movie-id="' + openId + '"]');
        if (trigger) trigger.click();
    }

    // Ripristina scroll da sessionStorage
    const savedScroll = sessionStorage.getItem('movie_list_scroll');
    if (savedScroll !== null) {
        const pos = parseInt(savedScroll, 10);
        if (!isNaN(pos)) window.scrollTo(0, pos);
        sessionStorage.removeItem('movie_list_scroll');
    }
});
</script>
{% endblock %}









